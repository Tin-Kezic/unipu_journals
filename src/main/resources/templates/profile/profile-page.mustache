<!DOCTYPE html>
<html lang="en" style="height: 100%; overflow: hidden;">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>{{fullName}}</title>
    <link rel="stylesheet" href="/util.css"/>
</head>
<body style="height: 100%; overflow: hidden; display: flex; flex-direction: column;">
{{>util/header}}
{{>util/dialog/info}}
{{>util/dialog/upsert}}
{{>util/dialog/boolean}}
{{>util/dialog/options}}
{{>util/components/manuscript/element}}
<div style="width: 100%; height: 100%; display: flex; flex-direction: row;">
    <aside style="width: 25vw; height: 100%; justify-content: center; display: flex; flex-direction: column; align-items: center; gap: 2rem; padding: 2rem;">
        <p style="font-size: 3rem; font-weight: lighter; max-width: 20rem; text-align: center;">{{fullName}}</p>
        {{#author}}
        <button onclick="window.location='/logout'" class="m3-button" style="width: 100%;">Log out</button>
        <button onclick='openInfoDialog(`{{{author}}}`)' class="m3-button" style="width: 100%; background-color: var(--frost-blue);">View profile</button>
        <button id="edit-profile" class="m3-button" style="width: 100%; background-color: var(--dark-grey); color: white;">Edit profile</button>
        <button id="delete-account" class="m3-button" style="width: 100%; background-color: var(--red); color: white;">Delete account</button>
        <script>
            document.getElementById('edit-profile').addEventListener('click', () => openOptionsDialog('Edit profile', [
                {name: 'Edit details', onClick: () => window.location=`${window.location.pathname}/edit`},
                {name: 'Change email', onClick: () => openUpsertDialog({
                    message: 'Change email',
                    positive: 'Change',
                    onPositive: async () => {
                        const response = await fetch('/api/accounts/email', { method: 'PUT', body: new URLSearchParams({
                            accountId: window.location.pathname.replace('/profiles/', ''),
                            newEmail: upsertDialogInput.value
                        })});
                        if(!response.ok) { alert(await response.text()); return; }
                        alert(`A confirmation email has been sent to ${upsertDialogInput.value}.\nVerify new email address within 15 minutes.`)
                    },
                    canCreateMore: false,
                    inputValue: '',
                    labelValue: 'email'
                })},
                {name: 'Change password', onClick: () => openUpdatePasswordDialog()}
            ]));
            document.getElementById('delete-account').addEventListener('click', () => openBooleanDialog('Permanently delete account', 'Delete', async () => {
                const response = await fetch(`/api/accounts`, {
                    method: 'DELETE', body: new URLSearchParams({ accountId: window.location.pathname.replace('/profiles/', '') })
                });
                if(!response.ok) { alert(await response.text()); return; }
                alert(`A confirmation email has been sent to your email address. Verify account deletion within 15 minutes.`);
            }));
        </script>
        {{/author}}
    </aside>
    <main style="display: flex; flex-direction: column; flex: 1; overflow: hidden; margin-left: 10%; width: 100%;">
        <div style="display: flex; flex-wrap: wrap; margin: 2rem 1rem 1rem 0rem; gap: 0.5rem;">

            <select aria-label="manuscript state" name="manuscript-state">
                <option value="PUBLISHED">Published manuscripts</option>
                {{#isAccountOwnerOrAdmin}}
                <option value="ALL_AWAITING_REVIEW">All awaiting review</option>
                <option value="AWAITING_EIC_REVIEW">Awaiting EiC review</option>
                <option value="AWAITING_EDITOR_REVIEW">Awaiting Editor review</option>
                <option value="AWAITING_REVIEWER_REVIEW">Awaiting reviewer review</option>
                <option value="MINOR_MAJOR">Minor/Major</option>
                <option value="REJECTED">Rejected</option>
                {{/isAccountOwnerOrAdmin}}
                <option value="ARCHIVED">Archived</option>
                {{#isAdmin}}<option value="HIDDEN">Hidden</option>{{/isAdmin}}
            </select>
            <script>const manuscriptStateSelect = document.querySelector('select[name="manuscript-state"]');</script>
            {{>util/components/select/category}}
            {{>util/components/select/sorting}}
            <script>
                const searchParams = new URLSearchParams(window.location.search);
                manuscriptStateSelect.value = searchParams.get('manuscriptStateFilter') || 'PUBLISHED';
                categorySelect.value = searchParams.get('category') || '';
                sortingSelect.value = searchParams.get('sorting') || 'ALPHABETICAL_A_Z';

                const params = () => new URLSearchParams({
                    manuscriptStateFilter: manuscriptStateSelect.value,
                    ...(categorySelect.value && { category: categorySelect.value }),
                    sorting: sortingSelect.value,
                });
                async function loadManuscripts() {
                    const response = await fetch(`/api/manuscripts?${params()}&role=AUTHOR&accountId=${window.location.pathname.replace('/profiles/', '')}`, { method: 'GET' });
                    if(!response.ok) { alert(await response.text()); return; }
                    renderManuscripts(await response.json(), 'manuscripts-container');
                    history.replaceState(null, '', `${window.location.pathname}?${params()}`);
                }
                [manuscriptStateSelect, categorySelect, sortingSelect].forEach(select => select.addEventListener('change', loadManuscripts));
                loadManuscripts();
            </script>
        </div>
        <div id="manuscripts-container" style="display: flex; flex-direction: column; gap: 0.5rem; margin-right: 1rem; overflow-y: auto; overflow-x: hidden; height: 100%; padding-bottom: 4rem;">
            <!-- on manuscriptStateSelect.includes('AWAITING'):
                <p style="font-size: 1.5rem; font-weight: 400;">Invited</p>
                <div id="manuscripts-container-invited" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
                <p style="font-size: 1.5rem; font-weight: 400;">Pending</p>
                <div id="manuscripts-container-pending" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
            -->
        </div>
    </main>
</div>
</body>
</html>
<style>
    .manuscript-container:hover {
        box-shadow: 0 0.1rem 0.2rem rgba(0, 0, 0, 0.2);
    }
    .manuscript-container-yellow:hover {
        background-color: var(--orange) !important;
        box-shadow: 0 0.1rem 0.2rem rgba(0, 0, 0, 0.2);
    }
    @media (max-width: 800px) {
        .manuscript-container {
            max-height: 40vh !important;
        }
        .manuscript-container-yellow {
            max-height: 40vh !important;
        }
        .m3-button.primary-button {
            text-wrap: wrap !important;
        }
        .container-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            min-width: 5rem;
        }
    }
</style>
<dialog id="update-password-dialog" closedby="any">
    <form id="update-password-dialog-form">
        <p id="update-password-dialog-message"></p>
        <div class="text-field" style="margin-bottom: 0.5rem;">
            <label for="update-password-dialog-current-password-input">current password</label>
            <input id="update-password-dialog-current-password-input" name="update-password-dialog-input" type="password" required>
        </div>
        <div class="text-field" style="margin-bottom: 0.5rem;">
            <label for="update-password-dialog-new-password-input">new password</label>
            <input id="update-password-dialog-new-password-input" name="update-password-dialog-input" type="password" required>
        </div>
        <div class="text-field" style="margin-bottom: 0.5rem;">
            <label for="update-password-dialog-new-password-confirmation-input">repeat password</label>
            <input id="update-password-dialog-new-password-confirmation-input" name="update-password-dialog-input" type="password" required>
        </div>
        <div style="display: flex; justify-content: space-between;">
            <button id="update-password-dialog-negative" class="m3-button outlined-button" type="button">Cancel</button>
            <button class="m3-button primary-button" style="box-shadow: none; padding-inline: 1.8rem;">Change password</button>
        </div>
    </form>
</dialog>
<script>
    const updatePasswordDialog = document.getElementById('update-password-dialog');
    const updatePasswordDialogCurrentPasswordInput = document.getElementById('update-password-dialog-current-password-input');
    const updatePasswordDialogNewPasswordInput = document.getElementById('update-password-dialog-new-password-input');
    const updatePasswordDialogNewPasswordConfirmationInput = document.getElementById('update-password-dialog-new-password-confirmation-input');
    function openUpdatePasswordDialog() { updatePasswordDialog.showModal(); }
    document.getElementById('update-password-dialog-negative').addEventListener('click', () => updatePasswordDialog.close());
    document.getElementById('update-password-dialog-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        if(updatePasswordDialogNewPasswordInput.value != updatePasswordDialogNewPasswordConfirmationInput.value) { alert("password mistmach"); return; }
        const response = await fetch('/api/accounts/password', { method: 'PUT', body: new URLSearchParams({
            accountId: window.location.pathname.replace('/profiles/', ''),
            currentPassword: updatePasswordDialogCurrentPasswordInput.value,
            newPassword: updatePasswordDialogNewPasswordInput.value
        })});
        if(!response.ok) { alert(await response.text()); return; }
        updatePasswordDialog.close();
    });
</script>