<!DOCTYPE html>
<html lang="en" style="height: 100%; overflow: hidden;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>publications</title>
    <link href="/util.css" rel="stylesheet"/>
</head>
<body style="height: 100%; overflow: hidden; display: flex; flex-direction: column;">
{{>util/header}}

<style>
    select {
        height: 2.7rem;
        font-size: 1rem;
        background: inherit;
        border: 1.2px solid var(--light-gray);
        border-radius: 0.3rem;
    }
</style>
<div style="display: flex; flex-wrap: wrap; margin: 2rem 1rem 1rem 1rem; gap: 0.5rem;">
    <select aria-label="manuscript state" name="manuscript-state">
        <option value="PUBLISHED">Published manuscripts</option>
        {{#isAuthenticated}}
        <option value="ALL_AWAITING_REVIEW">All awaiting review</option>
        <option value="AWAITING_EIC_REVIEW">Awaiting EiC review</option>
        <option value="AWAITING_EDITOR_REVIEW">Awaiting Editor review</option>
        <option value="AWAITING_REVIEWER_REVIEW">Awaiting reviewer review</option>
        <option value="MINOR_MAJOR">Minor/Major</option>
        <option value="REJECTED">Rejected</option>
        {{/isAuthenticated}}
        <option value="ARCHIVED">Archived</option>
        {{#isAdmin}}<option value="HIDDEN">Hidden</option>{{/isAdmin}}
    </select>
    {{#isAuthenticated}}
    <select aria-label="affiliation" name="affiliation">
        <option value="">Regardless of affiliation</option>
        <option value="EIC_ON_PUBLICATION">EiC on publication</option>
        <option value="SECTION_EDITOR">Section editor</option>
        <option value="EIC_ON_MANUSCRIPT">EiC on manuscript</option>
        <option value="EDITOR">Editor on manuscript</option>
        <option value="REVIEWER">Reviewer</option>
        <option value="CORRESPONDING_AUTHOR">Corresponding Author</option>
        <option value="AUTHOR">Author</option>
    </select>
    {{/isAuthenticated}}
    <select aria-label="category" name="category">
        <option value="">All categories</option>
        {{#categories}}<option value="{{.}}">{{.}}</option>{{/categories}}
    </select>
    <select aria-label="sorting" name="sorting">
        <option value="ALPHABETICAL_A_Z">Alphabetical (A-Z)</option>
        <option value="ALPHABETICAL_Z_A">Alphabetical (Z-A)</option>
        <option value="PUBLICATION_NEW">Newest publications</option>
        <option value="PUBLICATION_OLD">Oldest publications</option>
        <option value="VIEWS">Most viewed</option>
    </select>
    <script>
        publicationTypeSelect = document.querySelector('select[name="publication-type"]');

        {{#isAuthenticated}}
        affiliationSelect = document.querySelector('select[name="affiliation"]');
        {{/isAuthenticated}}
        manuscriptStateSelect = document.querySelector('select[name="manuscript-state"]');
        categorySelect = document.querySelector('select[name="category"]');
        sortingSelect = document.querySelector('select[name="sorting"]');
        class SidebarElement extends HTMLElement {
            constructor() {
                super();
            }
        }
        class Manuscript extends HTMLElement {
            constructor() {
                super();
            }
        }
        [{{#isAuthenticated}}affiliationSelect,{{/isAuthenticated}} manuscriptStateSelect, categorySelect, sortingSelect].forEach(select => select.addEventListener('change', async () => {
            const params = new URLSearchParams({
                affiliation: affiliationSelect.value,
                manuscriptStateFilter: manuscriptStateSelect.value,
                sorting: sortingSelect.value
            });
            // category is added separately because it's of type string and gets converted to '' instead of null like the other params which are enumerations
            if(categorySelect.value) params.set('category', categorySelect.value);
            const response = await fetch(`/api/publication?${params}`, { method: 'GET' });
            if(!response.ok) { alert(await response.text()); return; }
            const responsePublications = await response.json();
            const publicationsContainer = document.getElementById('publications-container');
            publicationsContainer.innerHTML = '';
            switch(manuscriptStateSelect.value) {
                case 'PUBLISHED':
                    responsePublications.forEach(containerDTO => {
                        const newPublication = document.createElement('div');
                        newPublication.dataset.id = containerDTO.id;
                        newPublication.className = 'container';
                        newPublication.style.cursor = 'pointer';
                        newPublication.onclick = displaSections(containerDTO.id);
                        newPublication.innerHTML = `PUB: ${containerDTO.id}`;
                        publicationsContainer.appendChild(newPublication);
                    });
                    break;
                case 'ALL_AWAITING_REVIEW':
                    responsePublications.forEach(containerDTO => {
                        /*
                            in case of the awaiting cases being equivalent use the fall through approach
                            case 1:
                            case 2:
                            case 3: x
                                ...
                            is equivalent to case 1, 2, 3: x
                        */
                    });
                    break;
                case 'AWAITING_EIC_REVIEW':
                    responsePublications.forEach(containerDTO => {

                    });
                    break;
                case 'AWAITING_EDITOR_REVIEW':
                    responsePublications.forEach(containerDTO => {

                    });
                    break;
                case 'AWAITING_REVIEWER_REVIEW':
                    responsePublications.forEach(containerDTO => {

                    });
                    break;
                case 'MINOR_MAJOR':
                    responsePublications.forEach(containerDTO => {

                    });
                    break;
                case 'REJECTED':
                    responsePublications.forEach(containerDTO => {

                    });
                    break;
                case 'ARCHIVED':
                    responsePublications.forEach(containerDTO => {

                    });
                    break;
                case 'HIDDEN':
                    responsePublications.forEach(containerDTO => {

                    });
                    break;
            }
        }));
        function displaySections(publicationId) {

        }
        function displayManuscripts(publicationId, sectionId) {

        }
    </script>
</div>

<main style="display: flex; flex: 1; overflow: hidden;">
    <div style="margin-left: 1rem; height: 100%;">
        {{#isAdmin}}<button id="add-publication" class="m3-button purple-button"  style="padding: 0.7rem 1.3rem; font-size: 1rem; border-radius: 0.5rem; box-shadow: none; width: 100%; margin-bottom: 0.5rem;">+ Add publication</button>{{/isAdmin}}
        {{^isAdmin}}Publications{{/isAdmin}}
        <aside id="publications-sidebar" style="display: flex; flex-direction: column; gap: 0.5rem; overflow-y: auto; overflow-x: hidden; height: 100%; padding-bottom: 4rem;">
            {{#publications}}
                <div class="sidebar-button" data-type="publication" data-id="{{id}}" style="display: flex; justify-content: space-between;">
                    <span style="overflow-wrap: break-word;
                        max-width: 
                        {{#isEicOnPublicationOrAdmin}} 80%; {{/isEicOnPublicationOrAdmin}}
                        {{^isEicOnPublicationOrAdmin}} 100%; {{/isEicOnPublicationOrAdmin}}
                    ">{{title}}</span>
                    {{#isEicOnPublicationOrAdmin}}<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="var()"><path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm112-260q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Z"/></svg>{{/isEicOnPublicationOrAdmin}}
                </div>
            {{/publications}}
        </aside>
    </div>
    <script>
        document.querySelectorAll('div[data-type="publication"]').forEach(publication => {

        });
    </script>
    <div style="margin-left: 1rem; height: 100%;">
    {{#isEicOnPublicationOrAdmin}}<button id="add-publication" class="m3-button purple-button"  style="padding: 0.7rem 1.3rem; font-size: 1rem; border-radius: 0.5rem; box-shadow: none; width: 100%; margin-bottom: 0.5rem;">+ Add Section</button>{{/isEicOnPublicationOrAdmin}}
    {{^isEicOnPublicationOrAdmin}}<legend id="sections-legend">Sections</legend>{{/isEicOnPublicationOrAdmin}}
        <aside id="sections-sidebar" style="display: flex; flex-direction: column; gap: 0.5rem; overflow-y: auto; overflow-x: hidden; height: 100%; padding-bottom: 4rem;">
        {{#publications}}
            <div class="sidebar-button" data-type="section" data-id="{{id}}" style="display: flex; justify-content: space-between; font-size: small; padding: 0.5rem;">
                <span style="
                    overflow-wrap: break-word;
                    max-width: 
                    {{#isSectionEditorOnSectionOrSuperior}} 80%; {{/isSectionEditorOnSectionOrSuperior}}
                    {{^isSectionEditorOnSectionOrSuperior}} 100%; {{/isSectionEditorOnSectionOrSuperior}}
                ">{{title}}</span>
                {{#isSectionEditorOnSectionOrSuperior}}<svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="24px" fill="var(--light-gray)"><path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm112-260q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Z"/></svg>{{/isSectionEditorOnSectionOrSuperior}}
            </div>
        {{/publications}}
    </aside>
    </div>
    <style>div:hover svg { fill: white; }</style>
</main>
<!--
<section id="publications-container" style="flex-direction: row; gap: 1rem; display: flex; flex-wrap: wrap; margin: 1rem 1.5rem;">
    {{#publications}}
        <div
            data-id="{{id}}"
            class="container"
            style="cursor: pointer;"
            onclick="window.location = '/publication/{{id}}'
        ">
            <p class="container-text" data-id="{{id}}">{{title}}</p>
            <div class="container-buttons">
                {{#canHide}}
                    <button
                        onclick="event.stopPropagation()"
                        data-type="hide-button"
                        data-id="{{id}}"
                        data-title="{{title}}"
                        class="m3-button purple-button"
                        style="font-size: 0.8rem; width: 3.8rem; box-shadow: none;"
                    >Hide</button>
                {{/canHide}}
                {{#canEdit}}
                    <button
                        onclick="event.stopPropagation()"
                        data-type="edit-button"
                        data-id="{{id}}"
                        data-title="{{title}}"
                        class="m3-button"
                        style="font-size: 0.8rem; width: 3.8rem; box-shadow: none;"
                    >Edit</button>
                {{/canEdit}}
            </div>
        </div>
    {{/publications}}
</section>
-->
{{#isAdmin}}
<dialog id="insert-publication-dialog" closedby="any">
    <p id="insert-publication-dialog-message">Add publication</p>
    <form id="insert-publication-dialog-form">
        <div class="text-field">
            <label>title</label>
            <input aria-label="publication title" type="text" name="insert-publication-dialog-input">
        </div>
        <div style="display: flex; justify-content: space-between">
            <button id="insert-publication-dialog-negative" class="m3-button outline-button" type="button">Cancel</button>
            <button class="m3-button purple-button" style="box-shadow: none; padding-inline: 1.8rem;">Add</button>
        </div>
    </form>
</dialog>
<script>
    const insertPublicationDialog = document.getElementById('insert-publication-dialog');
    document.getElementById('add-publication').addEventListener('click', () => insertPublicationDialog.showModal());
    document.getElementById('insert-publication-dialog-negative').addEventListener('click', () => insertPublicationDialog.close());
    document.getElementById('insert-publication-dialog-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const publicationTitle = document.querySelector('input[name=insert-publication-dialog-input]').value;
        const response = await fetch(`/api/publication?title=${encodeURIComponent(publicationTitle)}`, { method: 'POST' });
        if(!response.ok) { alert(await response.text()); return; }
        location.reload(true);
    });
</script>
{{/isAdmin}}

<dialog id="update-publication-title-dialog" closedby="any">
    <p id="update-publication-title-dialog-message"></p>
    <form id="update-publication-title-dialog-form">
        <div class="text-field">
            <label>title</label>
            <input aria-label="publication title" type="text" name="update-publication-title-dialog-input">
        </div>
        <div style="display: flex; justify-content: space-between">
            <button id="update-publication-title-dialog-negative" class="m3-button outline-button" type="button">Cancel</button>
            <button class="m3-button yellow-button" style="box-shadow: none; padding-inline: 0.8rem;">&nbsp&nbsp Edit &nbsp&nbsp</button>
        </div>
    </form>
</dialog>
<script>
    let currentId = null;
    const updatePublicationTitleDialog = document.getElementById('update-publication-title-dialog');
    const updatePublicationTitleDialogMessage = document.getElementById('update-publication-title-dialog-message');
    document.querySelectorAll('button[data-type="edit-button"]').forEach(button => {
        button.addEventListener('click', () => {
            updatePublicationTitleDialogMessage.innerHTML = `edit title of <b>${button.dataset.title}</b>`;
            currentId = button.dataset.id;
            updatePublicationTitleDialog.showModal();
        });
    });
    document.getElementById('update-publication-title-dialog-negative').addEventListener('click', () => updatePublicationTitleDialog.close());
    document.getElementById('update-publication-title-dialog-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const newPublicationTitle = document.querySelector('input[name="update-publication-title-dialog-input"]').value;
        const response = await fetch(`/api/publication/${currentId}?title=${encodeURIComponent(newPublicationTitle)}`, { method: 'PUT' });
        if(!response.ok) { alert(await response.text()); return; }
        location.reload(true);
    });
</script>

<dialog id="hide-publication-dialog" closedby="any">
    <p id="hide-publication-dialog-message"></p>
    <br>
    <div style="display: flex; justify-content: space-between">
        <button id="hide-publication-dialog-negative" class="m3-button outline-button">Cancel</button>
        <button id="hide-publication-dialog-positive" class="m3-button red-button" style="margin-left: 1rem; padding-inline: 1.7rem;">Hide</button>
    </div>
</dialog>
<script>
    const hidePublicationDialog = document.getElementById('hide-publication-dialog');
    const hidePublicationDialogMessage = document.getElementById('hide-publication-dialog-message');
    document.querySelectorAll('button[data-type="hide-button"]').forEach(button => {
        button.addEventListener('click', () => {
            hidePublicationDialogMessage.innerHTML = `Hide <b>${button.dataset.title}</b>?`;
            currentId = button.dataset.id;
            hidePublicationDialog.showModal();
        });
    });
    document.getElementById('hide-publication-dialog-negative').addEventListener('click', () => hidePublicationDialog.close());
    document.getElementById('hide-publication-dialog-positive').addEventListener('click', async () => {
        const response = await fetch(`/api/publication/${currentId}?isHidden=true`, { method: 'PUT' });
        if(!response.ok) { alert(await response.text()); return; }
        document.querySelector(`div[data-id="${currentId}"]`).remove();
        hidePublicationDialog.close();
    });
</script>
</body>
</html>