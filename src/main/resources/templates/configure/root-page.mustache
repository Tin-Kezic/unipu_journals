<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Root</title>
    <link rel="stylesheet" href="util.css"/>
    <script src="/htmx.min.js"></script>
</head>
<body>
<div class="wrapper" style="display: flex; flex-direction: row; justify-content: center; align-items: flex-start; height: 100vh; width: 100vw; gap: 10vw; margin-inline: 1rem;">
    <section style="max-width: 28rem; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; min-width: 22rem; padding-top: 4rem;">
        <h1 style="font-size: 3.5rem; align-self: flex-start;">Unipu Journals</h1>
        <p style="font-size: 1.3rem; color: var(--light-gray); margin-bottom: 3rem; align-self: flex-start; margin-left: 0.25rem;">Root page</p>
        <div style="max-width: 22.5rem; width: 100%; display: flex; flex-direction: column; align-items: center;">
            <p style="font-size: 1.8rem; font-weight: normal; margin-top: 2rem; align-self: center;">Update password</p>
            <form method="post" action="/root/update-password" style="width: 100%;">
                <div class="text-field">
                    <label>password</label>
                    <input name="password" type="password" required>
                </div>
                <div class="text-field">
                    <label>repeat password</label>
                    <input name="passwordConfirmation" type="password" required>
                </div>
                <div style="display: flex; justify-content: center;">
                    <button type="submit" class="m3-button yellow-button">Update</button>
                </div>
                <p style="color: var(--red); margin-top: 1rem; display: none; text-decoration: underline;">
                    Incorrect email or password.
                </p>
            </form>
        </div>
    </section>
    <main style="flex: 1; min-width: 18rem; max-width: 32rem; padding: 4rem 2rem 0 2rem; display: flex; flex-direction: column;">
        <section>
            <h2 style="font-weight: normal;">Admins</h2>
            <form hx-post="/root/add-admin" hx-swap="none" hx-on::after-request="handleAddAdminResponse(event)">
                <div style="display:flex; align-items:center; gap: 0.5rem;">
                    <div class="text-field">
                        <label>admin mail</label>
                        <input name="email" type="email" placeholder="email@unipu.hr">
                    </div>
                    <button type="submit" class="m3-button purple-button" style="padding-inline: 1rem; box-shadow: none; text-wrap: nowrap;">+ Add</button>
                </div>
            </form>
        </section>
        <section id="admin-list" class="users-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.6rem;">
            {{#admin-emails}}
                <button class="remove-user-button" data-email="{{.}}" onclick="showOverlayAndDialog('{{.}}')">
                    {{.}}
                    <svg xmlns="http://www.w3.org/2000/svg" height="32px" viewBox="0 -960 960 960" width="24px" fill="white"><path d="M640-520v-80h240v80H640Zm-280 40q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM40-160v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q66 0 130 15.5T616-378q29 15 46.5 43.5T680-272v112H40Zm80-80h480v-32q0-11-5.5-20T580-306q-54-27-109-40.5T360-360q-56 0-111 13.5T140-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T440-640q0-33-23.5-56.5T360-720q-33 0-56.5 23.5T280-640q0 33 23.5 56.5T360-560Zm0-80Zm0 400Z"/></svg>
                </button>
            {{/admin-emails}}
        </section>
    </main>
</div>
<div class="overlay">
    <div class="dialog">
        <p id="revoke-admin-privileges-for-email"></p>
        <p id="error-message" style="color: var(--red); display: none; margin-top: 1rem;"></p>
        <br>
        <form id="revoke-admin-form" hx-delete="/root/revoke-admin" hx-swap="none" hx-on::after-request="handleRemoveResponse(event)">
            <input type="hidden" name="email" id="revoke-admin-email">
            <div style="display: flex; justify-content: space-between">
                <button type="button" class="m3-button outline-button" onclick="hideOverlayAndDialog()">Cancel</button>
                <div style="display: flex; justify-content: flex-end">
                    <button type="submit" class="m3-button red-button">Remove</button>
                </div>
            </div>
        </form>
    </div>
</div>
</body>
<style>
    .text-field input {
        background-color: white;
    }
    @media (max-width: 768px) {
        .users-list {
            grid-template-columns: 1fr !important;
        }
        .wrapper {
            gap: 1rem !important;
        }
        .remove-user-button {
            width: 18rem !important;
        }
    }
</style>
<script>
    function showOverlayAndDialog(email) {
        document.querySelector('.overlay').classList.add('active');
        document.querySelector('.dialog').classList.add('active');
        document.getElementById('revoke-admin-privileges-for-email').innerHTML = `Revoke admin privileges for <b>${email}</b>`;
        document.getElementById('revoke-admin-email').value = email;
        document.getElementById('error-message').style.display = 'none'; // Reset error message
        htmx.process(document.getElementById('revoke-admin-form'));
    }
    function hideOverlayAndDialog() {
        document.querySelector('.overlay').classList.remove('active');
        document.querySelector('.dialog').classList.remove('active');
    }
    function handleRemoveResponse(event) {
        const email = document.getElementById('revoke-admin-email').value;
        if (event.detail.successful) {
            // Remove the specific admin button from the DOM
            const button = document.querySelector(`.remove-user-button[data-email="${email}"]`);
            if (button) button.remove();
            hideOverlayAndDialog();
        } else {
            // Show error message from server response
            const errorMessage = event.detail.xhr.responseText || 'Failed to revoke admin privileges.';
            document.getElementById('error-message').textContent = errorMessage;
            document.getElementById('error-message').style.display = 'block';
        }
    }
    function handleAddAdminResponse(event) {
        if (event.detail.successful) {
            // Extract email from the form input
            const emailInput = document.querySelector('input[name="email"]');
            const email = emailInput.value.trim();

            if (email) {
                // Create new button element
                const newButton = document.createElement('button');
                newButton.className = 'remove-user-button';
                newButton.dataset.email = email;
                newButton.onclick = () => showOverlayAndDialog(email);
                newButton.innerHTML = `
                    ${email}
                    <svg xmlns="http://www.w3.org/2000/svg" height="32px" viewBox="0 -960 960 960" width="24px" fill="white">
                        <path d="M640-520v-80h240v80H640Zm-280 40q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM40-160v-112q0-34 17.5-62.5T104-378q62-31 126-46.5T360-440q66 0 130 15.5T616-378q29 15 46.5 43.5T680-272v112H40Zm80-80h480v-32q0-11-5.5-20T580-306q-54-27-109-40.5T360-360q-56 0-111 13.5T140-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T440-640q0-33-23.5-56.5T360-720q-33 0-56.5 23.5T280-640q0 33 23.5 56.5T360-560Zm0-80Zm0 400Z"/>
                    </svg>
                `;

                // Append to admin list
                const adminList = document.getElementById('admin-list');
                adminList.appendChild(newButton);

                // Clear the input field
                emailInput.value = '';
            }
        } else { // error
            const errorMessage = event.detail.xhr.responseText || 'Failed to add admin.';
            alert(errorMessage);
        }
    }
    // Close dialog when clicking outside the form
    document.querySelector('.overlay').addEventListener('click', function(event) {
        if (event.target === this) {
            hideOverlayAndDialog();
        }
    });
</script>
</html>