<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Submit Page</title>
    <link rel="stylesheet" href="/util.css" />
</head>
<body>
{{>util/header}}

<div style="margin: 2rem; padding: 2rem; background-color: white; border: 1.3px solid var(--beige); border-radius: 0.4rem;">
    <form>
        <div class="text-field" style="width: 100%; margin-top: -0.5rem;">
            <label>title</label>
            <input name="title" type="text" required>
        </div>

        <div style="display: flex; flex-direction: row; gap: 0.3rem;">
            <select name="category" class="dropdown">
                <option value="category">Category</option>
                {{#categories}}<option value="{{.}}">{{.}}</option>{{/categories}}
            </select>

            {{#isAdmin}}
                <a href="/categories" type="button" class="m3-button primary-button" style="box-shadow: none; padding: 0.79rem 2rem; border-radius: 0.5rem; margin-left: 0.3rem; margin-right: 1rem; text-decoration: none;">Manage</a>
            {{/isAdmin}}

            <select name="publication" class="dropdown">
                <option value="publication">Publication</option>
                {{#publications}}<option value="{{.}}">{{.}}</option>{{/publications}}
            </select>

            <select name="section" class="dropdown">
                <option value="section">Section</option>
            </select>
            <script>
                const publicationSelect = document.querySelector('select[name="publication"]')
                const sectionSelect = document.querySelector('select[name="section"]')
                publicationSelect.addEventListener('change', async (event) => {
                    const response = await fetch(`/api/publications/${publicationSelect.value}/sections/titles`, { method: 'GET' });
                    if(!response.ok) { alert(await response.text()); return; }
                    sectionSelect.innerHTML = '';
                    const sectionTitles = await response.json();
                    sectionTitles.forEach(sectionTitle => {
                        newOption = document.createElement('option');
                        newOption.value = sectionTitle;
                        newOption.innerHTML = sectionTitle;
                        sectionSelect.appendChild(newOption);
                    });
                });
            </script>
        </div>

        <br><br>

        <p style="font-size: 0.8rem; color: var(--light-grey); margin-left: 0.5rem; margin-bottom: 0.3rem;">Author</p>
        <div class="author-container">
            <div class="text-field">
                <label>full name</label>
                <input name="full-name" type="text" required>
            </div>
            <div class="text-field">
                <label>institutional email</label>
                <input name="institutional-email" type="email" required>
            </div>
            <div class="text-field">
                <label>country</label>
                <input name="country" type="text" required>
            </div>
            <div class="text-field">
                <label>affiliation/institution</label>
                <input name="affiliation" type="text" required>
            </div>
            <button id="add-author" type="button" class="m3-button add-author" style="box-shadow: none; padding-inline: 1rem; border-radius: 0.5rem;">+ Add author</button>
            <script>
                document.getElementById('add-author').addEventListener('click', () => {
                    newAuthorContainer = document.createElement('div');
                    newAuthorContainer.className = 'author-container';
                    newAuthorContainer.innerHTML = `
                        <div class="text-field">
                            <label>full name</label>
                            <input name="full-name" type="text" required>
                        </div>
                        <div class="text-field">
                            <label>institutional email</label>
                            <input name="institutional-email" type="email" required>
                        </div>
                        <div class="text-field">
                            <label>country</label>
                            <input name="country" type="text" required>
                        </div>
                        <div class="text-field">
                            <label>affiliation/institution</label>
                            <input name="affiliation" type="text" required>
                        </div>

                        <button onclick="this.parentNode.remove()" type="button" class="m3-button add-author" style="box-shadow: none; padding-inline: 1rem; border-radius: 0.5rem;">Remove</button>

                        <label class="pale-yellow-checkbox-button">
                            <input type="checkbox" onclick="onCheckboxClick(this)" name="corresponding-author" hidden>
                            <span class="checkbox" style="width: 11rem; text-align: center; padding-block: 1.3rem; text-wrap: nowrap;">Corresponding author</span>
                        </label>
                    `;
                    document.getElementById('additional-authors').appendChild(newAuthorContainer);
                });
            </script>
            <label class="pale-yellow-checkbox-button">
                <input type="checkbox" onclick="onCheckboxClick(this)" name="corresponding-author" hidden>
                <span class="checkbox" style="width: 11rem; text-align: center; padding-block: 1.3rem; text-wrap: nowrap;">Corresponding author</span>
            </label>
        </div>

        <div id="additional-authors"></div>

        <div class="text-field">
            <label for="description">Description</label>
            <textarea id="description" required style="width:100%; resize:vertical; min-height: 20rem; padding: 1rem 2rem; font-size: 1rem; background-color: inherit;"></textarea>
        </div>
        <div style="display: flex; justify-content: space-between;">
            <label class="m3-button">Upload files
                <input type="file" multiple style="display: none; box-shadow: none; padding-inline: 1.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem;"/>
            </label>
            <button id="submit" class="m3-button primary-button">Submit</button>
        </div>
        <br> <br>
        <div id="file-list" style="display: flex; flex-direction: column; gap: 0.5rem;"></div>
    </form>
</div>
<dialog id="submitting-dialog" closedby="any"><p>Submitting...</p></dialog>
<script>
    function onCheckboxClick(checkbox) {
        document.querySelectorAll('input[name="corresponding-author"]').forEach(cb => cb.checked = false)
        checkbox.checked = true;
    }
    const fileInput = document.querySelector('input[type="file"]');
    const fileList = document.getElementById('file-list');
    const submitButton = document.getElementById('submit');
    const submittingDialog = document.getElementById('submitting-dialog');
    document.querySelector('form').addEventListener('submit', async (event) => {
        event.preventDefault();
        submittingDialog.showModal();
        submitButton.disabled = true;

        function earlyReturn() {
            submittingDialog.close();
            submitButton.disabled = false;
        }

        const category = document.querySelector('select[name="category"]').value;
        if(category == 'category') { alert('select a category'); earlyReturn(); return; }

        const publicationTitle = document.querySelector('select[name="publication"]').value;
        if(publicationTitle == 'publication') { alert('select a publication'); earlyReturn(); return; }

        const sectionName = document.querySelector('select[name="section"]').value;
        const title = document.querySelector('input[name="title"]').value;

        // authors
        const fullNames = document.querySelectorAll('input[name="full-name"]');
        const emails = document.querySelectorAll('input[name="institutional-email"]');
        const countries = document.querySelectorAll('input[name="country"]');
        const affiliations = document.querySelectorAll('input[name="affiliation"]');
        const isCorrespondingAuthorList = document.querySelectorAll('input[name="corresponding-author"]');

        const authors = Array.from(fullNames).map((_, index) => ({
            fullName: fullNames[index].value,
            email: emails[index].value,
            country: countries[index].value,
            affiliation: affiliations[index].value,
        }));

        let correspondingAuthorEmail
        authors.forEach((author, index) => { if(isCorrespondingAuthorList[index].checked) { correspondingAuthorEmail = authors[index].email }})
        if(!correspondingAuthorEmail) { alert('select corresponding author'); earlyReturn(); return; }

        const description = document.getElementById('description').value;
        if(fileInput.value.length === 0) { alert('submit files'); earlyReturn(); return; }

        const formData = new FormData();
        formData.append("manuscriptSubmission", new Blob([JSON.stringify({
            title,
            category,
            publicationTitle,
            sectionName,
            authors,
            correspondingAuthorEmail,
            description
        })], { type: "application/json" }));
        Array.from(fileInput.files).forEach(file => formData.append("files", file));

        const response = await fetch('/api/manuscripts', { method: 'POST', body: formData });
        if(!response.ok) { alert(await response.text()); earlyReturn(); return; }
        window.location = '/';
    });
    fileInput.addEventListener('change', () => {
        fileList.innerHTML = '';
        const forbiddenExtensions = [
            'exe', 'msi', 'bat', 'cmd', 'sh', 'app', 'apk', 'dll', 'so', 'bin', 'iso', 'dmg', 'img', 'pkg',
            'html', 'htm', 'css', 'js', 'php', 'asp', 'aspx',
            'psd', 'indd', 'cdr', 'sketch', 'key',
            'gif', 'webp', 'heic', 'heif', 'raw',
            'hdf', 'h5', 'sav', 'dta', 'mat',
            'rar', '7z', 'ace',
            'tmp', 'bak', '~doc', 'swp',
            'ttf', 'otf', 'fon'
        ];
        Array.from(fileInput.files).forEach(file => {
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if(forbiddenExtensions.includes(fileExtension)) {
                alert(`files of type .${fileExtension} are not allowed`);
                fileInput.value = '';
                submittingDialog.close();
                return;
            }
        });
        Array.from(fileInput.files).forEach(file => {
            const p = document.createElement('p');
            p.innerHTML = file.name;
            fileList.appendChild(p);
        });
    });
</script>
</body>
<style>
    select { width: 100%; }
    .author-container {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 0.5rem;
        align-items: center;
        padding-inline: 1rem;
        border: 1.3px solid var(--beige);
        border-radius: 0.4rem;
        margin: 1rem 0;
    }
    .author-container .text-field {
        flex: 1 1 12rem;
        min-width: 10rem;
    }
    .author-container .m3-button {
        flex: 0 1 auto;
        min-width: 8rem;
    }
    .author-container .remove-author {
        flex: 0 1 auto;
        min-width: 2.5rem;
        padding: 0.3rem 0.5rem;
    }
    @media (max-width: 480px) {
        .author-container .m3-button {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
    }
    @media (max-width: 768px) {
        .category-list {
            grid-template-columns: 1fr !important;
            justify-items: center;
        }
    }
</style>
</html>