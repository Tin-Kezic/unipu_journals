<script>
    document.addEventListener('manuscript-click', async (event) => {
        const inlineDisplayableTypes = [
            "txt", "log", "md", "markdown", "csv", "tsv",
            "json", "jsonl", "jsonld", "xml",
            "yaml", "yml", "toml",
            "ini", "cfg", "conf", "env", "sql",
            "svg", "xhtml", "webmanifest",
            "ts", "jsx", "tsx", "py", "java", "c", "cpp",
            "h", "hpp", "cs", "go", "rs", "rb",
            "swift", "kt", "scala", "lua", "r",
            "pl", "dart",
            "png", "jpg", "jpeg", "bmp", "ico",
            "avif", "tif", "tiff", "jfif",
            "mp3", "wav", "ogg", "opus", "m4a",
            "aac", "flac",
            "mp4", "m4v", "webm", "ogv", "3gp",
            "pdf", "epub",
            "woff", "woff2", "eot",
            "geojson", "ndjson",
            "fasta", "fastq", "vcf", "bed", "gff",
            "wasm"
        ];
        const { id, title } = event.detail;
        const currentElement = document.getElementById(id);
        const run = (x, f) => x ? f(x) : null;
        const files = run(currentElement.getAttribute('files'), JSON.parse);
        const fileAndOptions = Object.fromEntries(files.map(file => {
            const fileType = file.name.slice(file.name.lastIndexOf('.') + 1);
            const options = `<a href="/files?id=${file.id}">[Download]</a>${inlineDisplayableTypes.includes(fileType) ? `&nbsp<a href="/files?id=${file.id}&type=VIEW">[View]</a>` : ''}`;
            return [file.name, options];
        }))
        openInfoDialog(JSON.stringify(fileAndOptions))
    });
    [
        { type: 'manuscript-invite-accepted', operation: 'Accept', decision: true },
        { type: 'manuscript-invite-declined', operation: 'Decline', decision: false }
    ].forEach( it => {
        document.addEventListener(it.type, async (event) => {
            const { id, title, role } = event.detail;
            openBooleanDialog(`${it.operation} ${title}`, it.operation, async (event) => {
                const response = await fetch(`/api/invite?accept=${it.decision}&target=${encodeURIComponent(role.replace('EIC', 'EIC_ON_MANUSCRIPT'))}&targetId=${id.replace(/^.*-/, '')}`, { method: 'PUT' });
                if(!response.ok) { alert(await response.text()); return; }
                const currentElement = document.getElementById(id);
                const pending = document.getElementById(id.replace('invited', 'pending'));
                if(pending) {
                    const roles = JSON.parse(pending.getAttribute('roles'));
                    roles.push(role);
                    pending.setAttribute('roles', JSON.stringify(roles));
                    pending.setAttribute('options', `<button onclick="event.stopPropagation(); window.location='/review/${id.replace(/^.*-/, '')}'" class="m3-button outlined-button" style="width: auto; border-radius: 10rem; box-shadow: none; padding-inline: 1.7rem;">Review</button>`);
                    currentElement.remove();
                } else if(it.operation === 'Accept') {
                    currentElement.setAttribute('options', `<button onclick="event.stopPropagation(); window.location='/review/${id.replace(/^.*-/, '')}'" class="m3-button outlined-button" style="width: auto; border-radius: 10rem; box-shadow: none; padding-inline: 1.7rem;">Review</button>`);
                    currentElement.setAttribute('roles', JSON.stringify([role]));
                    currentElement.removeAttribute('role');
                    document.getElementById('manuscripts-container-pending').prepend(currentElement);
                }
            });
        });
    });
    [
        { type: 'manuscript-republished', operation: 'Republish', newState: 'PUBLISHED' },
        { type: 'manuscript-archived', operation: 'Archive', newState: 'ARCHIVED' },
        { type: 'manuscript-hidden', operation: 'Hide', newState: 'HIDDEN' }
    ].forEach( it => {
        document.addEventListener(it.type, async (event) => {
            const { id, title } = event.detail;
            openBooleanDialog(`${it.operation} ${title}`, it.operation, async (event) => {
                const response = await fetch(`/api/manuscripts/${id.replace(/^.*-/, '')}?newState=${it.newState}`, { method: 'PUT' });
                if(!response.ok) { alert(await response.text()); return; }
                document.getElementById(id).remove();
            });
        });
    });
</script>