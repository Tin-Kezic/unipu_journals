<script>
class Manuscript extends HTMLElement {
  static observedAttributes = [
  'id',
  'title',
  'description',
  'corresponding-author',
  'registered-authors',
  'unregistered-authors',
  'submission-date',
  'publication-date',
  'download-url',
  'is-overseeing',
  'roles',
  'role',
  'options',
  'state'
  ];
  constructor() { super(); }
  connectedCallback() {
    this.render();
    this.setupEventListeners();
  }
  attributeChangedCallback(name, oldValue, newValue) {
    if(newValue != oldValue) {
      this.render();
      this.setupEventListeners();
    }
  }
  render() {
    const run = (x, f) => x ? f(x) : null;
    this._id = this.getAttribute('id');
    this._title = this.getAttribute('title');
    this._description = this.getAttribute('description');
    this._correspondingAuthor = run(this.getAttribute('corresponding-author'), JSON.parse);
    this._registeredAuthors = run(this.getAttribute('registered-authors'), JSON.parse);
    this._unregisteredAuthors = run(this.getAttribute('unregistered-authors'), JSON.parse);
    this._submissionDate = this.getAttribute('submission-date');
    this._publicationDate = this.getAttribute('publication-date');
    this._downloadUrl = this.getAttribute('download-url');
    this._isOverseeing = this.getAttribute('is-overseeing') === 'true';
    this._roles = run(this.getAttribute('roles'), JSON.parse);
    this._role = this.getAttribute('role'); // role for invites
    this._options = this.getAttribute('options');
    this._state = this.getAttribute('state');
    this.innerHTML = /*html*/`
      <article onclick="window.location='${this._downloadUrl}'" class="container" style="width: auto; height: auto; max-width: 100%;">
        <p class="container-text">${this._title}</p>
        <div onclick="event.stopPropagation();" class="authors" style="display: flex; flex-wrap: wrap; font-weight: 100; font-size: 0.8rem;">
          ${this._registeredAuthors?.length ? this._registeredAuthors?.map(author => `
            <button onclick="window.location='/profiles/${author.id}';">${author.fullName}</button>
          `)?.join(',&nbsp') : '' }
          ${this._unregisteredAuthors?.length ? `,&nbsp${this._unregisteredAuthors?.map(author => {
            return `<button data-author='${JSON.stringify(this._isOverseeing ? author : { "Full name": author })}' onclick='openInfoDialog(this.dataset.author);'>${author.fullName ?? author}</button>`;
          })?.join(',&nbsp')}` : '' }
        </div>
        <div onclick="event.stopPropagation();" class="authors" style="display: flex; flex-wrap: wrap; font-weight: 100; font-size: 0.8rem;">
          Corresponding author:&nbsp${this._correspondingAuthor?.type === 'registered' ? `
            <button onclick="window.location='/profiles/${this._correspondingAuthor.id}';">${this._correspondingAuthor.fullName}</button>
          ` : `
            <button
              data-author='${JSON.stringify(this._isOverseeing ? this._correspondingAuthor : { "Full name": this._correspondingAuthor })}'
              onclick='openInfoDialog(this.dataset.author);'
            >${this._correspondingAuthor?.fullName ?? this._correspondingAuthor}
            </button>
          `}
        </div>
        ${this._roles?.length || this._role ? `
          <p style="font-weight: 100; font-size: 0.8rem; margin-top: 0.2rem;">
            ${this._roles?.length ? `Roles: ${this._roles.join(', ')}` : ''}
            ${this._role ? `Role: ${this._role}` : ''}
          </p>
        ` : ''}
        ${this._state?.includes('AWAITING') ? `
          <p style="font-weight: 100; font-size: 0.8rem; margin-top: 0.2rem;">
            State: ${this._state}
          </p>
        ` : ''}
        <p style="font-weight: 100; font-size: 0.8rem; margin-bottom: 0.5rem; margin-top: 0.2rem;">
          ${![null, 'null'].includes(this._publicationDate) ? `Published: ${this._publicationDate}` : `Submitted: ${this._submissionDate}`}
        </p>
        <p style="font-weight: 100; font-size: 0.8rem">${this._description}</p>
        ${this._options ? `
          <footer class="container-buttons" style="margin-top: 0.5rem; margin-bottom: 0;">
            ${this._options}
          </footer>
        ` : ''}
      </article>
    `;
  }
  _removeOldListeners() {
    if(this._acceptHandler) {
      this.querySelector('button[data-type="accept"]')?.removeEventListener('click', this._acceptHandler);
      this._acceptHandler = null;
    }
    if(this._declineHandler) {
      this.querySelector('button[data-type="decline"]')?.removeEventListener('click', this._declineHandler);
      this._declineHandler = null;
    }
    if(this._republishHandler) {
      this.querySelector('button[data-type="republish"]')?.removeEventListener('click', this._republishHandler);
      this._declineHandler = null;
    }
    if(this._archiveHandler) {
      this.querySelector('button[data-type="archive"]')?.removeEventListener('click', this._archiveHandler);
      this._archiveHandler= null;
    }
    if(this._hideHandler) {
      this.querySelector('button[data-type="hide"]')?.removeEventListener('click', this._hideHandler);
      this._hideHandler = null;
    }
  }
  basicDispatch(name) {
      this.dispatchEvent(new CustomEvent(name, {
        detail: {
          id: this._id,
          title: this._title,
          ...(name.includes('invite') && { role: this._role })
        },
        bubbles: true
      }))
  }
  setupEventListeners() {
    this._removeOldListeners();
    this._acceptHandler = () => this.basicDispatch('manuscript-invite-accepted');
    this._declineHandler = () => this.basicDispatch('manuscript-invite-declined');
    this._republishHandler = () => this.basicDispatch('manuscript-republished');
    this._archiveHandler = () => this.basicDispatch('manuscript-archived');
    this._hideHandler = () => this.basicDispatch('manuscript-hidden');
    this.querySelector('button[data-type="accept"]')?.addEventListener('click', this._acceptHandler);
    this.querySelector('button[data-type="decline"]')?.addEventListener('click', this._declineHandler);
    this.querySelector('button[data-type="republish"]')?.addEventListener('click', this._republishHandler);
    this.querySelector('button[data-type="archive"]')?.addEventListener('click', this._archiveHandler);
    this.querySelector('button[data-type="hide"]')?.addEventListener('click', this._hideHandler);
  }
  disconnectedCallback() { this._removeOldListeners(); }
}
customElements.define('manuscript-element', Manuscript);
</script>